

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpenZFS 补丁 &mdash; OpenZFS  documentation</title>
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme_overrides.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/mandoc.css" type="text/css" />

  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=b3ba4146"></script>
      <script src="../_static/doctools.js?v=888ff710"></script>
      <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #29667e" >

          
          
          <a href="../index.html">
            
              <img src="../_static/logo_main.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../Getting%20Started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Project%20and%20Community/index.html">项目和社区</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">开发者资源</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Performance%20and%20Tuning/index.html">性能与调优</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Basic%20Concepts/index.html">基本概念</a></li>
<li class="toctree-l1"><a class="reference internal" href="../man/index.html">Man Pages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../msg/index.html">ZFS Messages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../License.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #29667e" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OpenZFS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">OpenZFS 补丁</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/openzfs/openzfs-docs/blob/master/docs/Developer Resources/OpenZFS Patches.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="openzfs">
<h1>OpenZFS 补丁<a class="headerlink" href="#openzfs" title="Permalink to this heading"></a></h1>
<p>ZFS on Linux 项目是对上游 <a class="reference external" href="https://github.com/openzfs/openzfs/">OpenZFS 仓库</a> 的适配，旨在在 Linux 环境中工作。这个上游仓库是一个集成了来自所有 OpenZFS 平台的新功能、错误修复和性能改进的地方。每个平台负责跟踪 OpenZFS 仓库，并将相关改进合并到他们的版本中。</p>
<p>对于 ZFS on Linux 项目，这种跟踪是通过一个 <a class="reference external" href="http://build.zfsonlinux.org/openzfs-tracking.html">OpenZFS 跟踪</a> 页面来管理的。该页面会定期更新，并显示 OpenZFS 提交列表及其在 ZFS on Linux 主分支中的状态。</p>
<p>本页面描述了将未完成的 OpenZFS 提交应用到 ZFS on Linux 并提交这些更改以包含的过程。作为开发者，这是熟悉 ZFS on Linux 并快速为项目做出有价值贡献的好方法。以下指南假设您已经有一个 <a class="reference external" href="https://help.github.com/articles/signing-up-for-a-new-github-account/">GitHub 账户</a>，熟悉 git，并且习惯在 Linux 环境中开发。</p>
<section id="openzfs-zfs-on-linux">
<h2>将 OpenZFS 更改移植到 ZFS on Linux<a class="headerlink" href="#openzfs-zfs-on-linux" title="Permalink to this heading"></a></h2>
<section id="id1">
<h3>环境设置<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h3>
<p><strong>克隆源代码。</strong> 首先，克隆 <a class="reference external" href="https://github.com/zfsonlinux/spl">spl</a> 和 <a class="reference external" href="https://github.com/zfsonlinux/zfs">zfs</a> 仓库到本地。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git clone -o zfsonlinux https://github.com/zfsonlinux/spl.git
$ git clone -o zfsonlinux https://github.com/zfsonlinux/zfs.git
</pre></div>
</div>
<p><strong>添加远程仓库。</strong> 使用 GitHub 网页界面 <a class="reference external" href="https://help.github.com/articles/fork-a-repo/">fork</a> <a class="reference external" href="https://github.com/zfsonlinux/zfs">zfs</a> 仓库到您的个人 GitHub 账户。将您的新 zfs fork 和 <a class="reference external" href="https://github.com/openzfs/openzfs/">openzfs</a> 仓库添加为远程仓库，然后获取这两个仓库。OpenZFS 仓库很大，初始获取在慢速连接上可能需要一些时间。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd zfs
$ git remote add &lt;your-github-account&gt; git@github.com:&lt;your-github-account&gt;/zfs.git
$ git remote add openzfs https://github.com/openzfs/openzfs.git
$ git fetch --all
</pre></div>
</div>
<p><strong>编译源代码。</strong> 编译 spl 和 zfs 的主分支。这些分支始终保持稳定，这是验证您是否安装了完整的构建环境以及所有必需的依赖项是否可用的有用方法。这也可能加快后续小补丁的编译时间，因为增量构建是一个选项。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd ../spl
$ sh autogen.sh &amp;&amp; ./configure --enable-debug &amp;&amp; make -s -j$(nproc)
$
$ cd ../zfs
$ sh autogen.sh &amp;&amp; ./configure --enable-debug &amp;&amp; make -s -j$(nproc)
</pre></div>
</div>
</section>
<section id="id2">
<h3>选择一个补丁<a class="headerlink" href="#id2" title="Permalink to this heading"></a></h3>
<p>查阅 <a class="reference external" href="http://build.zfsonlinux.org/openzfs-tracking.html">OpenZFS 跟踪</a> 页面，并选择一个尚未应用的补丁。对于您的第一个补丁，您应该选择一个小补丁以熟悉该过程。</p>
</section>
<section id="id3">
<h3>移植补丁<a class="headerlink" href="#id3" title="Permalink to this heading"></a></h3>
<p>有两种方法：</p>
<ul class="simple">
<li><p><a class="reference external" href="#cherry-pick">cherry-pick（更简单）</a></p></li>
<li><p><a class="reference external" href="#manual-merge">手动合并</a></p></li>
</ul>
<p>请先阅读 <a class="reference external" href="#manual-merge">手动合并</a> 以了解整个过程。</p>
<section id="cherry-pick">
<h4>Cherry-pick<a class="headerlink" href="#cherry-pick" title="Permalink to this heading"></a></h4>
<p>您可以自己开始 <a class="reference external" href="https://git-scm.com/docs/git-cherry-pick">cherry-pick</a>，但我们提供了一个特殊的 <a class="reference external" href="https://github.com/zfsonlinux/zfs-buildbot/blob/master/scripts/openzfs-merge.sh">脚本</a>，它会尝试自动 <a class="reference external" href="https://git-scm.com/docs/git-cherry-pick">cherry-pick</a> 补丁并生成描述。</p>
<ol class="arabic simple" start="0">
<li><p>准备环境：</p></li>
</ol>
<p>必需的 git 设置（添加到 <code class="docutils literal notranslate"><span class="pre">~/.gitconfig</span></code>）：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">merge</span><span class="p">]</span>
    <span class="n">renameLimit</span> <span class="o">=</span> <span class="mi">999999</span>
<span class="p">[</span><span class="n">user</span><span class="p">]</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">mail</span><span class="nd">@yourmail</span><span class="o">.</span><span class="n">com</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Your</span> <span class="n">Name</span>
</pre></div>
</div>
<p>下载脚本：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">zfsonlinux</span><span class="o">/</span><span class="n">zfs</span><span class="o">-</span><span class="n">buildbot</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">openzfs</span><span class="o">-</span><span class="n">merge</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<ol class="arabic simple">
<li><p>运行：</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">openzfs</span><span class="o">-</span><span class="n">merge</span><span class="o">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">d</span> <span class="n">path_to_zfs_folder</span> <span class="o">-</span><span class="n">c</span> <span class="n">openzfs_commit_hash</span>
</pre></div>
</div>
<p>此命令将获取所有仓库，创建一个新分支 <a href="#id4"><span class="problematic" id="id5">``</span></a>autoport-ozXXXX``（XXXX - OpenZFS 问题编号），尝试 cherry-pick，编译并在成功时检查 cstyle。</p>
<p>如果它成功且没有任何合并冲突 - 转到 <code class="docutils literal notranslate"><span class="pre">autoport-ozXXXX</span></code> 分支，它将有一个准备提交的提交。恭喜，您可以转到步骤 7！</p>
<p>否则，您应该转到步骤 2。</p>
<ol class="arabic simple" start="2">
<li><p>手动解决所有合并冲突。简单的方法 - 安装 <a class="reference external" href="http://meldmerge.org/">Meld</a> 或任何其他差异工具并运行 <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">mergetool</span></code>。</p></li>
<li><p>检查所有编译和 cstyle 错误（参见 <a class="reference external" href="#testing-a-patch">测试补丁</a>）。</p></li>
<li><p>提交您的更改并附上任何描述。</p></li>
<li><p>更新提交描述（最后一次提交将被更改）：</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">openzfs</span><span class="o">-</span><span class="n">merge</span><span class="o">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">d</span> <span class="n">path_to_zfs_folder</span> <span class="o">-</span><span class="n">g</span> <span class="n">openzfs_commit_hash</span>
</pre></div>
</div>
<ol class="arabic simple" start="6">
<li><p>添加任何移植说明（如果您修改了某些内容）：<code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">commit</span> <span class="pre">--amend</span></code></p></li>
<li><p>将您的提交推送到 GitHub：<code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">push</span> <span class="pre">&lt;your-github-account&gt;</span> <span class="pre">autoport-ozXXXX</span></code></p></li>
<li><p>创建一个拉取请求到 ZoL 主分支。</p></li>
<li><p>转到 <a class="reference external" href="#testing-a-patch">测试补丁</a> 部分。</p></li>
</ol>
</section>
<section id="id6">
<h4>手动合并<a class="headerlink" href="#id6" title="Permalink to this heading"></a></h4>
<p><strong>创建一个新分支。</strong> 为每个移植到 ZFS on Linux 的提交创建一个新分支非常重要。这将允许您轻松地将您的工作作为 GitHub 拉取请求提交，并使您能够同时处理多个 OpenZFS 更改。所有开发分支都需要基于 ZFS 主分支，并且以您正在处理的问题编号命名分支会很有帮助。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git checkout -b openzfs-&lt;issue-nr&gt; master
</pre></div>
</div>
<p><strong>生成补丁。</strong> 您首先会注意到的一件事是，ZFS on Linux 仓库的布局与 OpenZFS 仓库不同。在组织上，它要扁平得多，这是因为它只包含 OpenZFS 的代码，而不是整个操作系统。这意味着，为了应用来自 OpenZFS 的补丁，补丁中的路径名称必须更改。提供了一个名为 zfs2zol-patch.sed 的脚本来执行此转换。使用 <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">format-patch</span></code> 命令和此脚本来生成补丁。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git format-patch --stdout &lt;commit-hash&gt;^..&lt;commit-hash&gt; | \
    ./scripts/zfs2zol-patch.sed &gt;openzfs-&lt;issue-nr&gt;.diff
</pre></div>
</div>
<p><strong>应用补丁。</strong> 在许多情况下，生成的补丁将干净地应用到仓库。但是，请记住，zfs2zol-patch.sed 脚本仅转换路径。通常还有其他原因导致补丁可能无法应用。在某些情况下，补丁的部分内容可能不适用于 Linux，应该删除。在其他情况下，补丁可能依赖于必须先应用的其他更改。这些更改也可能与 Linux 特定的修改冲突。在所有这些情况下，都需要手动修改补丁以干净地应用，同时保留其原始意图。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git am ./openzfs-&lt;commit-nr&gt;.diff
</pre></div>
</div>
<p><strong>更新提交消息。</strong> 通过使用 <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">format-patch</span></code> 生成补丁，然后使用 <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">am</span></code> 应用它，原始评论和作者身份将得以保留。但是，由于 OpenZFS 提交的格式，您可能会发现整个提交评论都被压缩到了主题行中。使用 <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">commit</span> <span class="pre">--amend</span></code> 清理评论，并小心遵循 <a class="reference external" href="http://tbaggery.com/2008/04/19/a-note-about-git-commit-messages.html">这些标准指南</a>。</p>
<p>OpenZFS 提交的摘要行通常很长，您应该将其截断为 50 个字符。这很有用，因为它保留了 <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">log</span> <span class="pre">--pretty=oneline</span></code> 命令的正确格式。确保在摘要和提交正文之间留一个空行。然后包括完整的 OpenZFS 提交消息，换行任何超过 72 个字符的行。最后，添加一个 <code class="docutils literal notranslate"><span class="pre">Ported-by</span></code> 标签，包含您的联系信息，以及一个 <code class="docutils literal notranslate"><span class="pre">OpenZFS-issue</span></code> 和 <code class="docutils literal notranslate"><span class="pre">OpenZFS-commit</span></code> 标签，并附上适当的链接。您需要验证您的提交包含以下所有信息：</p>
<ul class="simple">
<li><p>原始 OpenZFS 补丁的主题行，格式为：”OpenZFS &lt;issue-nr&gt; - 简短描述”。</p></li>
<li><p>原始补丁的作者身份应保留。</p></li>
<li><p>OpenZFS 提交消息。</p></li>
<li><p>以下标签：</p>
<ul>
<li><p><strong>Authored by:</strong> 原始补丁作者</p></li>
<li><p><strong>Reviewed by:</strong> 原始补丁的所有 OpenZFS 审阅者。</p></li>
<li><p><strong>Approved by:</strong> 原始补丁的所有 OpenZFS 审阅者。</p></li>
<li><p><strong>Ported-by:</strong> 您的姓名和电子邮件地址。</p></li>
<li><p><strong>OpenZFS-issue:</strong> https ://www.illumos.org/issues/issue</p></li>
<li><p><strong>OpenZFS-commit:</strong> https
://github.com/openzfs/openzfs/commit/hash</p></li>
</ul>
</li>
<li><p><strong>移植说明:</strong> 可选部分，描述移植时所需的任何更改。</p></li>
</ul>
<p>例如，OpenZFS 问题 6873 已 <a class="reference external" href="https://github.com/zfsonlinux/zfs/commit/b3744ae">应用到 Linux</a>，来自此上游 <a class="reference external" href="https://github.com/openzfs/openzfs/commit/ee06391">OpenZFS 提交</a>。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>OpenZFS 6873 - zfs_destroy_snaps_nvl 泄漏 errlist

Authored by: Chris Williamson &lt;chris.williamson@delphix.com&gt;
Reviewed by: Matthew Ahrens &lt;mahrens@delphix.com&gt;
Reviewed by: Paul Dagnelie &lt;pcd@delphix.com&gt;
Ported-by: Denys Rtveliashvili &lt;denys@rtveliashvili.name&gt;

lzc_destroy_snaps() 返回一个 nvlist 在 errlist 中。
zfs_destroy_snaps_nvl() 应该在返回之前 nvlist_free() 它。

OpenZFS-issue: https://www.illumos.org/issues/6873
OpenZFS-commit: https://github.com/openzfs/openzfs/commit/ee06391
</pre></div>
</div>
</section>
</section>
<section id="id7">
<h3>测试补丁<a class="headerlink" href="#id7" title="Permalink to this heading"></a></h3>
<p><strong>编译源代码。</strong> 验证修补后的源代码可以无错误地编译，并解决所有警告。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ make -s -j$(nproc)
</pre></div>
</div>
<p><strong>运行样式检查器。</strong> 验证修补后的源代码通过样式检查器，命令应返回而不打印任何输出。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ make cstyle
</pre></div>
</div>
<p><strong>打开拉取请求。</strong> 当您的补丁干净地构建并通过样式检查时，<a class="reference external" href="https://help.github.com/articles/creating-a-pull-request/">打开一个新的拉取请求</a>。拉取请求将排队进行 <a class="reference external" href="https://github.com/zfsonlinux/zfs-buildbot/">自动化测试</a>。作为测试的一部分，该更改将针对广泛的 Linux 发行版进行构建，并运行一系列功能和压力测试以检测回归。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git push &lt;your-github-account&gt; openzfs-&lt;issue-nr&gt;
</pre></div>
</div>
<p><strong>修复任何问题。</strong> 测试大约需要 2 小时才能完全完成，结果将发布在 GitHub <a class="reference external" href="https://github.com/zfsonlinux/zfs/pull/4594">拉取请求</a> 中。所有测试都应通过，您应该调查并解决任何测试失败。<a class="reference external" href="https://github.com/zfsonlinux/zfs-buildbot/tree/master/scripts">测试脚本</a> 都可用，并且设计为在本地运行以重现问题。一旦您解决了问题，强制更新拉取请求以触发新一轮测试。迭代直到所有测试都通过。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># 修复问题，修改提交，强制更新分支。
$ git commit --amend
$ git push --force &lt;your-github-account&gt; openzfs-&lt;issue-nr&gt;
</pre></div>
</div>
</section>
<section id="id8">
<h3>合并补丁<a class="headerlink" href="#id8" title="Permalink to this heading"></a></h3>
<p><strong>审查。</strong> 最后，ZFS on Linux 的维护者之一将对补丁进行最终审查，并可能请求额外的更改。一旦维护者对补丁的最终版本感到满意，他们将添加他们的签名，将其合并到主分支，在跟踪页面上标记为完成，并感谢您对项目的贡献！</p>
</section>
</section>
<section id="zfs-on-linux-openzfs">
<h2>将 ZFS on Linux 更改移植到 OpenZFS<a class="headerlink" href="#zfs-on-linux-openzfs" title="Permalink to this heading"></a></h2>
<p>通常，问题会首先在 ZFS on Linux 中修复或开发新功能。非 Linux 特定的更改应提交到上游 OpenZFS GitHub 仓库进行审查。此过程在 <a class="reference external" href="https://github.com/openzfs/openzfs/">OpenZFS README</a> 中有描述。</p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, OpenZFS.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>